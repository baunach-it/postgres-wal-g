name: Postgres Backup & Restore
on:
  push:
    branches: [main]

jobs:
  get-postgres-versions:
      runs-on: ubuntu-latest
      outputs:
        matrix: ${{ steps.get-versions.outputs.matrix }}
      steps:
        - name: Install required packages
          run: |
            sudo apt-get update
            sudo apt-get install -y curl jq
        - id: get-versions
          run: |
            POSTGRES_VERSIONS=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/postgres/tags/?page_size=1024" | jq -c '[.results[].name | select(test("rc|beta|alpine|latest") | not) | select(test("^[0-9]+(\\.[0-9]+)*")) | select((split("-")[0] | split(".")[0] | tonumber) > 16)] | sort')
            MANUAL_WAL_G_VERSIONS='["v3.0.7/wal-g-pg-ubuntu-24.04-amd64 # wal-g-3.0.7-ubuntu-24.04", "v3.0.6/wal-g-pg-ubuntu-24.04-amd64 # wal-g-3.0.6-ubuntu-24.04"]'
            MATRIX=$(jq -c -n --argjson postgres "$POSTGRES_VERSIONS" --argjson wal_g "$MANUAL_WAL_G_VERSIONS" '{ versions: [ { "postgres": $postgres[], "wal_g": $wal_g[] } ] }')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX"      
  build-and-publish-matrix:
    needs: get-postgres-versions
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.get-postgres-versions.outputs.matrix) }}
    steps:
      - name: Github Environment Variables
        run: |
          echo "ðŸ”Ž github.repository=${{github.repository}}"
          echo "ðŸ”Ž github.sha=${{github.sha}}"
          echo "ðŸ”Ž github.event.repository.name=${{github.event.repository.name}}"
          echo "ðŸ”Ž github.ref_name=${{github.ref_name}}"
          echo "ðŸ”Ž github.workspace=${{github.workspace}}"
          echo "ðŸ”Ž postgres.version=${{matrix.versions.postgres}}"
          echo "ðŸ”Ž wal_g.version=$(echo '${{ matrix.versions.wal_g }}' | cut -d'#' -f1 | xargs)"
          echo "ðŸ”Ž wal_g.version.mapped=$(echo '${{ matrix.versions.wal_g }}' | cut -d'#' -f2 | xargs)"
          echo "ðŸ”Ž docker.tag = baunach/${{ github.event.repository.name }}:${{ matrix.versions.postgres }}-$(echo '${{ matrix.versions.wal_g }}' | cut -d'#' -f2 | xargs)"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESSTOKEN_RW }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        if: false
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/386,linux/amd64
          build-args: |
            BASE_IMAGE_VERSION=${{matrix.versions.postgres}}
            WAL_G_VERSION=${{matrix.versions.wal_g}} | cut -d'#' -f1 | xargs"
          tags: "baunach/${{ github.event.repository.name }}:${{ matrix.versions.postgres }}-$(echo '${{ matrix.versions.wal_g }}' | cut -d'#' -f2 | xargs)"
